name: Build FFTW3 for HarmonyOS (Docker Fixed)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Build in Docker
      run: |
        # åˆ›å»º Dockerfile
        cat > Dockerfile << 'EOF'
        FROM ubuntu:22.04

        ENV DEBIAN_FRONTEND=noninteractive

        # å®‰è£…åŸºç¡€å·¥å…·å’Œäº¤å‰ç¼–è¯‘å·¥å…·é“¾
        RUN apt-get update && apt-get install -y \
            wget build-essential cmake git \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            && rm -rf /var/lib/apt/lists/*

        # ä¸‹è½½ FFTW3
        RUN wget http://www.fftw.org/fftw-3.3.10.tar.gz && \
            tar -xzf fftw-3.3.10.tar.gz

        # ç¼–è¯‘
        WORKDIR /fftw-3.3.10
        RUN ./configure \
              --host=aarch64-linux-gnu \
              --prefix=/output \
              --enable-shared \
              --enable-float \
              --enable-threads \
              --disable-fortran \
              CC=aarch64-linux-gnu-gcc \
              CXX=aarch64-linux-gnu-g++ \
              CFLAGS="-fPIC -O3" \
            && make -j$(nproc) \
            && make install

        # éªŒè¯
        RUN file /output/lib/libfftw3f.so && \
            aarch64-linux-gnu-readelf -d /output/lib/libfftw3f.so | grep NEEDED || true

        WORKDIR /output
        EOF
        
        # æ„å»ºé•œåƒ
        docker build -t fftw-builder .
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p output
        
        # å¤åˆ¶äº§ç‰©
        docker create --name temp fftw-builder
        docker cp temp:/output/lib/libfftw3f.so output/
        docker cp temp:/output/lib/libfftw3f.so.3 output/ || true
        docker cp temp:/output/include/fftw3.h output/
        docker rm temp
        
        echo "ğŸ“Š Build Results:"
        ls -lh output/
        file output/libfftw3f.so
        
    - name: Create README
      run: |
        cat > output/README.md << 'EOF'
        # FFTW3 for HarmonyOS (ARM64)

        ## æ–‡ä»¶è¯´æ˜
        - `libfftw3f.so` - FFTW3 å•ç²¾åº¦åŠ¨æ€åº“ï¼ˆARM64ï¼‰
        - `fftw3.h` - å¤´æ–‡ä»¶

        ## ä½¿ç”¨æ–¹æ³•

        ### 1. å¤åˆ¶åˆ°é¸¿è’™é¡¹ç›®
        ```bash
        cp libfftw3f.so your_project/entry/libs/arm64-v8a/
        cp fftw3.h your_project/entry/src/main/cpp/include/
        ```

        ### 2. CMakeLists.txt é…ç½®
        ```cmake
        # æ·»åŠ å¤´æ–‡ä»¶è·¯å¾„
        include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)

        # å¯¼å…¥é¢„ç¼–è¯‘åº“
        add_library(fftw3f SHARED IMPORTED)
        set_target_properties(fftw3f PROPERTIES
            IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/../libs/arm64-v8a/libfftw3f.so
        )

        # é“¾æ¥
        target_link_libraries(entry PUBLIC fftw3f)
        ```

        ### 3. C++ ä»£ç ç¤ºä¾‹
        ```cpp
        #include "fftw3.h"
        #include <hilog/log.h>

        void performFFT() {
            const int N = 1024;
            
            // åˆ†é…å†…å­˜
            fftwf_complex *in = (fftwf_complex*)fftwf_malloc(sizeof(fftwf_complex) * N);
            fftwf_complex *out = (fftwf_complex*)fftwf_malloc(sizeof(fftwf_complex) * N);
            
            // åˆ›å»ºè®¡åˆ’
            fftwf_plan plan = fftwf_plan_dft_1d(N, in, out, FFTW_FORWARD, FFTW_ESTIMATE);
            
            // å¡«å……æµ‹è¯•æ•°æ®
            for (int i = 0; i < N; i++) {
                in[i][0] = i; // å®éƒ¨
                in[i][1] = 0; // è™šéƒ¨
            }
            
            // æ‰§è¡Œ FFT
            fftwf_execute(plan);
            
            OH_LOG_INFO(LOG_APP, "FFT completed! First result: %f + %fi", 
                        out[0][0], out[0][1]);
            
            // æ¸…ç†
            fftwf_destroy_plan(plan);
            fftwf_free(in);
            fftwf_free(out);
        }
        ```

        ### 4. module.json5 é…ç½®
        ```json
        {
          "module": {
            "name": "entry",
            "type": "entry",
            "abilities": [...],
            "metadata": [
              {
                "name": "ArkTSPartialUpdate",
                "value": "true"
              }
            ]
          }
        }
        ```

        ## æŠ€æœ¯ç»†èŠ‚
        - **æ¶æ„**: ARM64 (aarch64)
        - **ç¼–è¯‘å™¨**: GCC 11.x (aarch64-linux-gnu)
        - **ä¼˜åŒ–**: -O3
        - **çº¿ç¨‹**: æ”¯æŒå¤šçº¿ç¨‹
        - **ç²¾åº¦**: å•ç²¾åº¦æµ®ç‚¹ (float)

        ## å¸¸è§é—®é¢˜

        ### Q: åœ¨è®¾å¤‡ä¸Šè¿è¡ŒæŠ¥é”™ "library not found"
        A: ç¡®ä¿ï¼š
        1. `libfftw3f.so` åœ¨ `entry/libs/arm64-v8a/` ç›®å½•
        2. CMakeLists.txt æ­£ç¡®é…ç½® IMPORTED_LOCATION
        3. ä½¿ç”¨çœŸæœºæˆ– ARM64 æ¨¡æ‹Ÿå™¨æµ‹è¯•

        ### Q: é“¾æ¥æ—¶æŠ¥é”™ undefined reference
        A: æ£€æŸ¥ï¼š
        ```cmake
        target_link_libraries(entry PUBLIC fftw3f)  # ç¡®ä¿åœ¨æœ€å
        ```

        ### Q: æ€§èƒ½ä¼˜åŒ–å»ºè®®
        A: 
        - ä½¿ç”¨ `FFTW_MEASURE` æ›¿ä»£ `FFTW_ESTIMATE`ï¼ˆé¦–æ¬¡æ…¢ï¼Œåç»­å¿«ï¼‰
        - é‡ç”¨ planï¼Œé¿å…é‡å¤åˆ›å»º
        - è€ƒè™‘ä½¿ç”¨ NEON ä¼˜åŒ–ç‰ˆæœ¬

        ## éªŒè¯ä¿¡æ¯
        ```bash
        $ file libfftw3f.so
        libfftw3f.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked
        ```

        ---
        æ„å»ºæ—¶é—´: $(date)
        FFTW ç‰ˆæœ¬: 3.3.10
        EOF
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fftw3-harmonyos-arm64
        path: output/*
        retention-days: 30
