name: Build FFTW3 for HarmonyOS (Docker)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Build in Docker
      run: |
        # 创建 Dockerfile
        cat > Dockerfile << 'EOF'
        FROM ubuntu:22.04

        # 安装基础工具
        RUN apt-get update && apt-get install -y \
            wget build-essential cmake git \
            clang-15 lld-15

        # 下载 FFTW3
        RUN wget http://www.fftw.org/fftw-3.3.10.tar.gz && \
            tar -xzf fftw-3.3.10.tar.gz

        # 编译
        WORKDIR /fftw-3.3.10
        RUN CC=clang-15 \
            CXX=clang++-15 \
            CFLAGS="--target=aarch64-linux-gnu -fPIC -O3" \
            LDFLAGS="--target=aarch64-linux-gnu" \
            ./configure \
              --host=aarch64-linux-gnu \
              --prefix=/output \
              --enable-shared \
              --enable-float \
              --enable-threads \
              --disable-fortran && \
            make -j$(nproc) && \
            make install

        WORKDIR /output
        EOF
        
        # 构建
        docker build -t fftw-builder .
        
        # 复制产物
        docker create --name temp fftw-builder
        docker cp temp:/output/lib/libfftw3f.so output/
        docker cp temp:/output/include/fftw3.h output/
        docker rm temp
        
        ls -lh output/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fftw3-harmonyos
        path: output/*
