name: Build FFTW3 for HarmonyOS (Official NDK)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup OHOS SDK
      run: |
        # ‰∏ãËΩΩ DevEco Studio ÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑
        wget https://contentcenter-vali-drcn.dbankcdn.cn/pvt_2/DeveloperAlliance_package_901_9/9a/v3/HBD1VL9fTVSW7bs1K0dnPw/command-line-tools-linux-5.0.3.403.zip
        
        unzip -q command-line-tools-linux-5.0.3.403.zip -d ~/cmdline-tools
        
        # ÂÆâË£Ö SDK
        ~/cmdline-tools/bin/sdkmanager --install "OpenHarmony 5.0.0(12)" --sdk-root=$HOME/ohos-sdk
        
        # È™åËØÅÂÆâË£Ö
        find $HOME/ohos-sdk -name "clang" -type f
    
    - name: Build FFTW3
      run: |
        # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
        export OHOS_SDK_ROOT=$HOME/ohos-sdk
        export OHOS_NDK=$OHOS_SDK_ROOT/12/native
        
        # Êü•ÊâæÂ∑•ÂÖ∑Èìæ
        CLANG=$(find $OHOS_NDK -name "clang" -path "*/llvm/bin/*" | head -1)
        CLANG_DIR=$(dirname $CLANG)
        
        export PATH="$CLANG_DIR:$PATH"
        export CC="$CLANG"
        export AR="$CLANG_DIR/llvm-ar"
        export RANLIB="$CLANG_DIR/llvm-ranlib"
        
        # ‰∏ãËΩΩ FFTW
        wget http://www.fftw.org/fftw-3.3.10.tar.gz
        tar -xzf fftw-3.3.10.tar.gz
        cd fftw-3.3.10
        
        # ÈÖçÁΩÆÂπ∂ÁºñËØë
        ./configure \
          --host=aarch64-linux-ohos \
          --prefix=$HOME/install \
          --enable-shared \
          --enable-float \
          --enable-threads \
          --disable-fortran \
          CC="$CC" \
          CFLAGS="--target=aarch64-linux-ohos -fPIC -O3" \
          LDFLAGS="--target=aarch64-linux-ohos"
        
        make -j$(nproc)
        make install
        
        # È™åËØÅ
        echo "üìä Build completed!"
        file $HOME/install/lib/libfftw3f.so
        $CLANG_DIR/llvm-readelf -d $HOME/install/lib/libfftw3f.so | grep NEEDED
    
    - name: Package
      run: |
        mkdir -p output
        cp $HOME/install/lib/libfftw3f.so* output/
        cp $HOME/install/include/fftw3.h output/
        
        # ÂàõÂª∫‰ΩøÁî®ËØ¥Êòé
        cat > output/README.md << 'EOF'
        # FFTW3 for HarmonyOS (Official Build)
        
        ## È™åËØÅ‰ø°ÊÅØ
        ```
        Platform: ARM64 (aarch64-linux-ohos)
        Compiler: OHOS NDK Clang
        Dependencies: HarmonyOS system libraries
        ```
        
        ## ÈõÜÊàêÊ≠•È™§
        
        ### 1. ÁõÆÂΩïÁªìÊûÑ
        ```
        entry/
        ‚îú‚îÄ‚îÄ libs/
        ‚îÇ   ‚îî‚îÄ‚îÄ arm64-v8a/
        ‚îÇ       ‚îî‚îÄ‚îÄ libfftw3f.so
        ‚îî‚îÄ‚îÄ src/main/cpp/
            ‚îú‚îÄ‚îÄ CMakeLists.txt
            ‚îú‚îÄ‚îÄ include/
            ‚îÇ   ‚îî‚îÄ‚îÄ fftw3.h
            ‚îî‚îÄ‚îÄ hello.cpp
        ```
        
        ### 2. CMakeLists.txt
        ```cmake
        cmake_minimum_required(VERSION 3.4.1)
        project(FFTWDemo)
        
        # Ê∑ªÂä†Â§¥Êñá‰ª∂
        include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)
        
        # ÂØºÂÖ•È¢ÑÁºñËØëÂ∫ì
        add_library(fftw3f SHARED IMPORTED)
        set_target_properties(fftw3f PROPERTIES
            IMPORTED_LOCATION "${CMAKE_CURRENT_SOURCE_DIR}/../libs/${OHOS_ARCH}/libfftw3f.so"
        )
        
        # ‰Ω†ÁöÑÊ∫êÊñá‰ª∂
        add_library(entry SHARED hello.cpp)
        
        # ÈìæÊé•Â∫ìÔºàÈ°∫Â∫èÂæàÈáçË¶ÅÔºÅÔºâ
        target_link_libraries(entry PUBLIC
            fftw3f
            hilog_ndk.z
        )
        ```
        
        ### 3. C++ ‰ª£Á†Å
        ```cpp
        #include <napi/native_api.h>
        #include <hilog/log.h>
        #include "fftw3.h"
        
        static napi_value TestFFT(napi_env env, napi_callback_info info) {
            const int N = 128;
            
            fftwf_complex *in = fftwf_alloc_complex(N);
            fftwf_complex *out = fftwf_alloc_complex(N);
            
            fftwf_plan p = fftwf_plan_dft_1d(N, in, out, FFTW_FORWARD, FFTW_ESTIMATE);
            
            // Â°´ÂÖÖÊµãËØïÊï∞ÊçÆ
            for(int i = 0; i < N; i++) {
                in[i][0] = i;
                in[i][1] = 0;
            }
            
            fftwf_execute(p);
            
            OH_LOG_INFO(LOG_APP, "FFT Result[0]: %f + %fi", out[0][0], out[0][1]);
            
            fftwf_destroy_plan(p);
            fftwf_free(in);
            fftwf_free(out);
            
            napi_value result;
            napi_get_boolean(env, true, &result);
            return result;
        }
        
        EXTERN_C_START
        static napi_value Init(napi_env env, napi_value exports) {
            napi_property_descriptor desc[] = {
                { "testFFT", nullptr, TestFFT, nullptr, nullptr, nullptr, napi_default, nullptr }
            };
            napi_define_properties(env, exports, sizeof(desc) / sizeof(desc[0]), desc);
            return exports;
        }
        EXTERN_C_END
        
        static napi_module demoModule = {
            .nm_version = 1,
            .nm_flags = 0,
            .nm_filename = nullptr,
            .nm_register_func = Init,
            .nm_modname = "entry",
            .nm_priv = nullptr,
            .reserved = { 0 },
        };
        
        extern "C" __attribute__((constructor)) void RegisterModule() {
            napi_module_register(&demoModule);
        }
        ```
        
        ### 4. ArkTS Ë∞ÉÁî®
        ```typescript
        import testNapi from 'libentry.so'
        
        @Entry
        @Component
        struct Index {
          build() {
            Column() {
              Button('Run FFT Test')
                .onClick(() => {
                  let result = testNapi.testFFT()
                  console.log('FFT test result:', result)
                })
            }
          }
        }
        ```
        EOF
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: fftw3-harmonyos-official
        path: output/*
        retention-days: 30
