name: Build FFTW3 for HarmonyOS (Fixed)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download OHOS NDK
      run: |
        sudo apt-get update
        sudo apt-get install -y wget aria2 unzip tree
        
        echo "ðŸ“¥ Downloading OHOS SDK..."
        aria2c -x 16 -s 16 -d /tmp \
          "https://repo.huaweicloud.com/openharmony/os/5.0-Release/ohos-sdk-windows_linux-public.tar.gz"
        
        echo "ðŸ“¦ Extracting main package..."
        mkdir -p /tmp/sdk
        tar -xzf /tmp/ohos-sdk-windows_linux-public.tar.gz -C /tmp/sdk
        
        echo "ðŸ” Exploring SDK structure..."
        tree -L 3 /tmp/sdk || find /tmp/sdk -maxdepth 3 -type f -o -type d
        
        echo "ðŸ“¦ Finding and extracting native SDK..."
        NATIVE_SDK=$(find /tmp/sdk -name "native*.zip" -type f | head -1)
        
        if [ -z "$NATIVE_SDK" ]; then
          echo "âŒ ERROR: Native SDK not found!"
          echo "Available files:"
          find /tmp/sdk -type f -name "*.zip"
          exit 1
        fi
        
        echo "âœ… Found: $NATIVE_SDK"
        mkdir -p $HOME/ohos-ndk
        unzip -q "$NATIVE_SDK" -d $HOME/ohos-ndk
        
        echo "ðŸ” NDK directory structure:"
        tree -L 3 $HOME/ohos-ndk || find $HOME/ohos-ndk -maxdepth 3
        
        echo "ðŸ”Ž Searching for clang..."
        find $HOME/ohos-ndk -name "clang" -type f
        
    - name: Setup Toolchain
      run: |
        # æŸ¥æ‰¾ clang çš„å¤šç§å¯èƒ½è·¯å¾„
        CLANG_PATH=""
        
        # å°è¯• 1: æ ‡å‡†è·¯å¾„
        if [ -f "$HOME/ohos-ndk/native/llvm/bin/clang" ]; then
          CLANG_PATH="$HOME/ohos-ndk/native/llvm/bin/clang"
        # å°è¯• 2: ç›´æŽ¥åœ¨ llvm ä¸‹
        elif [ -f "$HOME/ohos-ndk/llvm/bin/clang" ]; then
          CLANG_PATH="$HOME/ohos-ndk/llvm/bin/clang"
        # å°è¯• 3: æœç´¢æ•´ä¸ªç›®å½•
        else
          CLANG_PATH=$(find $HOME/ohos-ndk -name "clang" -type f -path "*/bin/clang" | head -1)
        fi
        
        if [ -z "$CLANG_PATH" ]; then
          echo "âŒ ERROR: Clang still not found after extensive search!"
          echo "Full directory listing:"
          find $HOME/ohos-ndk -type f | head -50
          exit 1
        fi
        
        echo "âœ… Clang found: $CLANG_PATH"
        
        # èŽ·å–å·¥å…·é“¾æ ¹ç›®å½•
        NDK_ROOT=$(dirname $(dirname $(dirname $CLANG_PATH)))
        echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
        
        # éªŒè¯å·¥å…·é“¾
        echo "ðŸ”§ Toolchain info:"
        $CLANG_PATH --version
        
        # æ£€æŸ¥å…¶ä»–å·¥å…·
        LLVM_BIN=$(dirname $CLANG_PATH)
        echo "LLVM_BIN=$LLVM_BIN" >> $GITHUB_ENV
        
        ls -la $LLVM_BIN/
        
    - name: Download FFTW3
      run: |
        wget http://www.fftw.org/fftw-3.3.10.tar.gz
        tar -xzf fftw-3.3.10.tar.gz
        
    - name: Build FFTW3
      run: |
        cd fftw-3.3.10
        
        export CC="$LLVM_BIN/clang"
        export CXX="$LLVM_BIN/clang++"
        export AR="$LLVM_BIN/llvm-ar"
        export RANLIB="$LLVM_BIN/llvm-ranlib"
        export STRIP="$LLVM_BIN/llvm-strip"
        
        export CFLAGS="--target=aarch64-linux-ohos -fPIC -O3"
        export CXXFLAGS="--target=aarch64-linux-ohos -fPIC -O3"
        export LDFLAGS="--target=aarch64-linux-ohos"
        
        echo "ðŸ”¨ Build Configuration:"
        echo "CC: $CC"
        echo "CXX: $CXX"
        $CC --version
        
        ./configure \
          --host=aarch64-linux-ohos \
          --prefix=$HOME/fftw3-install \
          --enable-shared \
          --enable-float \
          --enable-threads \
          --disable-fortran
          
        make -j$(nproc)
        make install
        
    - name: Verify Build
      run: |
        echo "ðŸ“Š Build Results:"
        ls -lh $HOME/fftw3-install/lib/
        
        echo "ðŸ” Library info:"
        file $HOME/fftw3-install/lib/libfftw3f.so
        
        echo "ðŸ“š Dependencies:"
        readelf -d $HOME/fftw3-install/lib/libfftw3f.so | grep NEEDED || true
        
    - name: Package files
      run: |
        mkdir -p output
        cp $HOME/fftw3-install/lib/libfftw3f.so output/
        cp $HOME/fftw3-install/lib/libfftw3f.a output/ 2>/dev/null || true
        cp $HOME/fftw3-install/include/fftw3.h output/
        
        cat > output/README.md << 'EOF'
        # FFTW3 for HarmonyOS (ARM64)

        ## æ–‡ä»¶è¯´æ˜Ž
        - `libfftw3f.so` - åŠ¨æ€åº“ï¼ˆå•ç²¾åº¦æµ®ç‚¹ï¼‰
        - `libfftw3f.a` - é™æ€åº“ï¼ˆå¦‚æžœç”Ÿæˆï¼‰
        - `fftw3.h` - å¤´æ–‡ä»¶

        ## é›†æˆåˆ°é¸¿è’™é¡¹ç›®

        ### 1. å¤åˆ¶æ–‡ä»¶
        ```bash
        cp libfftw3f.so your_project/entry/libs/arm64-v8a/
        cp fftw3.h your_project/entry/src/main/cpp/include/
        ```

        ### 2. é…ç½® CMakeLists.txt
        ```cmake
        # æ·»åŠ é¢„ç¼–è¯‘åº“
        add_library(fftw3f SHARED IMPORTED)
        set_target_properties(fftw3f PROPERTIES
            IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/../libs/arm64-v8a/libfftw3f.so
        )

        # é“¾æŽ¥åˆ°ä½ çš„ç›®æ ‡
        target_link_libraries(entry PUBLIC fftw3f)
        ```

        ### 3. ä½¿ç”¨ç¤ºä¾‹
        ```cpp
        #include "fftw3.h"

        void example() {
            int N = 1024;
            fftwf_complex *in = (fftwf_complex*) fftwf_malloc(sizeof(fftwf_complex) * N);
            fftwf_complex *out = (fftwf_complex*) fftwf_malloc(sizeof(fftwf_complex) * N);
            
            fftwf_plan plan = fftwf_plan_dft_1d(N, in, out, FFTW_FORWARD, FFTW_ESTIMATE);
            fftwf_execute(plan);
            
            fftwf_destroy_plan(plan);
            fftwf_free(in);
            fftwf_free(out);
        }
        ```

        ## æž„å»ºä¿¡æ¯
        - Target: aarch64-linux-ohos
        - OHOS SDK: 5.0 Release
        - FFTW Version: 3.3.10
        - Build Type: Float (single precision)
        EOF
        
        echo "âœ… Package contents:"
        ls -lh output/
        cat output/README.md
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fftw3-harmonyos-arm64
        path: output/*
