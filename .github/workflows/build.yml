name: Build FFTW3 for HarmonyOS (Official NDK)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download OHOS NDK
      run: |
        # å®‰è£…ä¾èµ–
        sudo apt-get update
        sudo apt-get install -y wget aria2 unzip
        
        # å¤šçº¿ç¨‹ä¸‹è½½ SDKï¼ˆçº¦ 5 åˆ†é’Ÿï¼‰
        echo "Downloading OHOS SDK..."
        aria2c -x 16 -s 16 -d /tmp \
          "https://repo.huaweicloud.com/openharmony/os/5.0-Release/ohos-sdk-windows_linux-public.tar.gz"
        
        # è§£å‹ä¸»åŒ…
        echo "Extracting main package..."
        mkdir -p /tmp/sdk
        tar -xzf /tmp/ohos-sdk-windows_linux-public.tar.gz -C /tmp/sdk
        
        # æŸ¥æ‰¾å¹¶è§£å‹ native SDK
        echo "Finding native SDK..."
        NATIVE_SDK=$(find /tmp/sdk -name "native-linux*.zip" | head -1)
        
        if [ -z "$NATIVE_SDK" ]; then
          echo "ERROR: Native SDK not found!"
          echo "Available files:"
          find /tmp/sdk -type f
          exit 1
        fi
        
        echo "Extracting native SDK: $NATIVE_SDK"
        unzip -q "$NATIVE_SDK" -d $HOME/ohos-ndk
        
        # éªŒè¯å·¥å…·é“¾
        echo "=== Toolchain verification ==="
        CLANG_PATH=$(find $HOME/ohos-ndk -name "clang" -type f | grep llvm/bin | head -1)
        if [ -z "$CLANG_PATH" ]; then
          echo "ERROR: Clang not found!"
          exit 1
        fi
        
        echo "Clang found at: $CLANG_PATH"
        $CLANG_PATH --version
        
    - name: Download FFTW3
      run: |
        wget http://www.fftw.org/fftw-3.3.10.tar.gz
        tar -xzf fftw-3.3.10.tar.gz
        
    - name: Build FFTW3
      run: |
        cd fftw-3.3.10
        
        # å®šä½å·¥å…·é“¾
        NDK_ROOT=$(find $HOME/ohos-ndk -type d -name "llvm" | head -1 | xargs dirname)
        
        export CC="$NDK_ROOT/llvm/bin/clang"
        export CXX="$NDK_ROOT/llvm/bin/clang++"
        export AR="$NDK_ROOT/llvm/bin/llvm-ar"
        export RANLIB="$NDK_ROOT/llvm/bin/llvm-ranlib"
        export STRIP="$NDK_ROOT/llvm/bin/llvm-strip"
        
        # ğŸ”‘ å…³é”®ï¼šä½¿ç”¨ OHOS ç›®æ ‡
        export CFLAGS="--target=aarch64-linux-ohos -fPIC -O3"
        export CXXFLAGS="--target=aarch64-linux-ohos -fPIC -O3"
        export LDFLAGS="--target=aarch64-linux-ohos"
        
        echo "=== Build Configuration ==="
        echo "CC: $CC"
        $CC --version
        echo "Target: aarch64-linux-ohos"
        
        # é…ç½®
        ./configure \
          --host=aarch64-linux-ohos \
          --prefix=$HOME/fftw3-install \
          --enable-shared \
          --enable-float \
          --enable-threads \
          --disable-fortran
          
        # ç¼–è¯‘
        make -j$(nproc)
        make install
        
    - name: Verify Build
      run: |
        echo "=== Verification ==="
        ls -lh $HOME/fftw3-install/lib/
        
        # æ£€æŸ¥åº“çš„ç›®æ ‡æ¶æ„
        file $HOME/fftw3-install/lib/libfftw3f.so
        
        # æ£€æŸ¥ä¾èµ–ï¼ˆåº”è¯¥åªä¾èµ–ç³»ç»Ÿåº“ï¼‰
        readelf -d $HOME/fftw3-install/lib/libfftw3f.so | grep NEEDED || true
        
    - name: Package files
      run: |
        mkdir -p output
        cp $HOME/fftw3-install/lib/libfftw3f.so output/
        cp $HOME/fftw3-install/lib/libfftw3f.a output/
        cp $HOME/fftw3-install/include/fftw3.h output/
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜
        cat > output/README.md << 'EOF'
        # FFTW3 for HarmonyOS (ARM64)
        
        ## æ–‡ä»¶è¯´æ˜
        - `libfftw3f.so` - åŠ¨æ€åº“ï¼ˆå•ç²¾åº¦æµ®ç‚¹ï¼‰
        - `libfftw3f.a` - é™æ€åº“
        - `fftw3.h` - å¤´æ–‡ä»¶
        
        ## ä½¿ç”¨æ–¹æ³•
        
        ### 1. é›†æˆåˆ°é¸¿è’™é¡¹ç›®
        ```bash
        # å¤åˆ¶åˆ°é¡¹ç›®çš„ libs/arm64-v8a/ ç›®å½•
        cp libfftw3f.so your_project/entry/libs/arm64-v8a/
        ```
        
        ### 2. é…ç½® CMakeLists.txt
        ```cmake
        add_library(fftw3f SHARED IMPORTED)
        set_target_properties(fftw3f PROPERTIES
            IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/../libs/arm64-v8a/libfftw3f.so
        )
        target_link_libraries(your_target fftw3f)
        ```
        
        ### 3. C++ ä»£ç ç¤ºä¾‹
        ```cpp
        #include <fftw3.h>
        
        // åˆ›å»ºè®¡åˆ’
        fftwf_plan plan = fftwf_plan_dft_1d(1024, in, out, FFTW_FORWARD, FFTW_ESTIMATE);
        
        // æ‰§è¡Œ FFT
        fftwf_execute(plan);
        
        // é‡Šæ”¾
        fftwf_destroy_plan(plan);
        ```
        
        ## æ„å»ºä¿¡æ¯
        - Target: aarch64-linux-ohos
        - Toolchain: OHOS NDK 5.0
        - Build Date: $(date)
        EOF
        
        echo "=== Output Files ==="
        ls -lh output/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fftw3-harmonyos-arm64
        path: output/*
